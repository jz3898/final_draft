```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(plotly)
library(viridis)
pm25_asthma <- read_csv("data/merged_pm25_asthma.csv")
glimpse(pm25_asthma)
```

```{r data-prep}
# Prepare data for time-series analysis
pm25_asthma_clean <- pm25_asthma %>%
  mutate(
    borough = factor(borough, 
                     levels = c("Manhattan", "Bronx", "Brooklyn", 
                                "Queens", "Staten Island"))
  ) %>%
  arrange(year, borough)

# Create a summary table
summary_stats <- pm25_asthma_clean %>%
  group_by(borough) %>%
  summarise(
    mean_pm25 = mean(pm25_annual, na.rm = TRUE),
    mean_asthma = mean(asthma_rate, na.rm = TRUE),
    n_years = n()
  )

knitr::kable(summary_stats, digits = 2, 
             caption = "Summary Statistics by Borough")
```

```{r pm25-timeseries, fig.width=10, fig.height=6}
# Interactive time-series plot of PM2.5 by borough
p1 <- pm25_asthma_clean %>%
  plot_ly(x = ~year, y = ~pm25_annual, color = ~borough,
          type = 'scatter', mode = 'lines+markers',
          colors = viridis(5),
          hovertemplate = paste(
            '<b>%{fullData.name}</b><br>',
            'Year: %{x}<br>',
            'PM2.5: %{y:.2f} μg/m³<br>',
            '<extra></extra>'
          )) %>%
  layout(
    title = list(
      text = "<b>Annual PM2.5 Concentrations by Borough (2009-2023)</b>",
      font = list(size = 16)
    ),
    xaxis = list(
      title = "Year",
      tickfont = list(size = 12),
      gridcolor = 'rgba(200,200,200,0.3)'
    ),
    yaxis = list(
      title = "PM2.5 (μg/m³)",
      tickfont = list(size = 12),
      gridcolor = 'rgba(200,200,200,0.3)'
    ),
    hovermode = 'closest',
    legend = list(
      title = list(text = '<b>Borough</b>'),
      orientation = 'v',
      x = 1.02,
      y = 1
    ),
    plot_bgcolor = 'rgba(250,250,250,0.9)',
    paper_bgcolor = 'white',
    margin = list(r = 150)
  )

p1
```

```{r asthma-timeseries, fig.width=10, fig.height=6}
# Interactive time-series plot of asthma ED visit rates by borough
p2 <- pm25_asthma_clean %>%
  plot_ly(x = ~year, y = ~asthma_rate, color = ~borough,
          type = 'scatter', mode = 'lines+markers',
          colors = viridis(5, option = "plasma"),
          hovertemplate = paste(
            '<b>%{fullData.name}</b><br>',
            'Year: %{x}<br>',
            'ED Visit Rate: %{y:.1f} per 10,000<br>',
            '<extra></extra>'
          )) %>%
  layout(
    title = list(
      text = "<b>Asthma Emergency Department Visit Rates by Borough (2009-2023)</b>",
      font = list(size = 16)
    ),
    xaxis = list(
      title = "Year",
      tickfont = list(size = 12),
      gridcolor = 'rgba(200,200,200,0.3)'
    ),
    yaxis = list(
      title = "ED Visit Rate (per 10,000 population)",
      tickfont = list(size = 12),
      gridcolor = 'rgba(200,200,200,0.3)'
    ),
    hovermode = 'closest',
    legend = list(
      title = list(text = '<b>Borough</b>'),
      orientation = 'v',
      x = 1.02,
      y = 1
    ),
    plot_bgcolor = 'rgba(250,250,250,0.9)',
    paper_bgcolor = 'white',
    margin = list(r = 150)
  )

p2
```

```{r combined-view, fig.width=10, fig.height=8}
# Combined subplot showing both metrics side by side
combined_plot <- subplot(
  p1 %>% layout(showlegend = TRUE),
  p2 %>% layout(showlegend = FALSE),
  nrows = 2,
  shareX = FALSE,
  titleY = TRUE,
  margin = 0.08
) %>%
  layout(
    title = list(
      text = "<b>Air Quality and Asthma Trends in NYC Boroughs</b>",
      font = list(size = 18)
    ),
    height = 800,
    xaxis = list(title = "Year"),
    xaxis2 = list(title = "Year")
  )

combined_plot
```

```{r trend-analysis}
# Calculate year-over-year changes
trends <- pm25_asthma_clean %>%
  group_by(borough) %>%
  arrange(year) %>%
  mutate(
    pm25_change = pm25_annual - lag(pm25_annual),
    asthma_change = asthma_rate - lag(asthma_rate)
  ) %>%
  filter(!is.na(pm25_change))

# Summary of trends
trend_summary <- trends %>%
  summarise(
    avg_pm25_change = mean(pm25_change, na.rm = TRUE),
    avg_asthma_change = mean(asthma_change, na.rm = TRUE),
    correlation = cor(pm25_change, asthma_change, use = "complete.obs")
  )

knitr::kable(trend_summary, digits = 3,
             caption = "Average Annual Changes and Correlation by Borough")
```

```{r dual-axis-manhattan, fig.width=10, fig.height=5}
# Manhattan dual-axis plot
manhattan_data <- pm25_asthma_clean %>% filter(borough == "Manhattan")

plot_ly(manhattan_data) %>%
  add_trace(
    x = ~year, 
    y = ~pm25_annual,
    name = "PM2.5",
    type = "scatter",
    mode = "lines+markers",
    line = list(color = "#440154", width = 3),
    marker = list(size = 8),
    yaxis = "y1",
    hovertemplate = paste(
      '<b>PM2.5</b><br>',
      'Year: %{x}<br>',
      'PM2.5: %{y:.2f} μg/m³<br>',
      '<extra></extra>'
    )
  ) %>%
  add_trace(
    x = ~year,
    y = ~asthma_rate,
    name = "Asthma ED Rate",
    type = "scatter",
    mode = "lines+markers",
    line = list(color = "#FDE724", width = 3, dash = "dash"),
    marker = list(size = 8, symbol = "square"),
    yaxis = "y2",
    hovertemplate = paste(
      '<b>Asthma ED Rate</b><br>',
      'Year: %{x}<br>',
      'Rate: %{y:.1f} per 10,000<br>',
      '<extra></extra>'
    )
  ) %>%
  layout(
    title = list(
      text = "<b>Manhattan: PM2.5 and Asthma ED Rates (2009-2023)</b>",
      font = list(size = 16)
    ),
    xaxis = list(title = "Year", tickfont = list(size = 12)),
    yaxis = list(
      title = "<b style='color:#440154'>PM2.5 (μg/m³)</b>",
      titlefont = list(color = "#440154", size = 14),
      tickfont = list(color = "#440154", size = 12),
      side = "left"
    ),
    yaxis2 = list(
      title = "<b style='color:#FDE724'>ED Visit Rate (per 10,000)</b>",
      titlefont = list(color = "#FDE724", size = 14),
      tickfont = list(color = "#FDE724", size = 12),
      overlaying = "y",
      side = "right"
    ),
    legend = list(
      x = 0.02,
      y = 0.98,
      xanchor = "left",
      yanchor = "top",
      bgcolor = "rgba(255,255,255,0.8)",
      bordercolor = "rgba(0,0,0,0.3)",
      borderwidth = 1
    ),
    hovermode = "x unified",
    plot_bgcolor = 'rgba(250,250,250,0.9)',
    paper_bgcolor = 'white',
    margin = list(r = 100, t = 60)
  )
```

```{r dual-axis-bronx, fig.width=10, fig.height=5}
# Bronx dual-axis plot
bronx_data <- pm25_asthma_clean %>% filter(borough == "Bronx")

plot_ly(bronx_data) %>%
  add_trace(
    x = ~year, 
    y = ~pm25_annual,
    name = "PM2.5",
    type = "scatter",
    mode = "lines+markers",
    line = list(color = "#31688E", width = 3),
    marker = list(size = 8),
    yaxis = "y1",
    hovertemplate = paste(
      '<b>PM2.5</b><br>',
      'Year: %{x}<br>',
      'PM2.5: %{y:.2f} μg/m³<br>',
      '<extra></extra>'
    )
  ) %>%
  add_trace(
    x = ~year,
    y = ~asthma_rate,
    name = "Asthma ED Rate",
    type = "scatter",
    mode = "lines+markers",
    line = list(color = "#CC4678", width = 3, dash = "dash"),
    marker = list(size = 8, symbol = "square"),
    yaxis = "y2",
    hovertemplate = paste(
      '<b>Asthma ED Rate</b><br>',
      'Year: %{x}<br>',
      'Rate: %{y:.1f} per 10,000<br>',
      '<extra></extra>'
    )
  ) %>%
  layout(
    title = list(
      text = "<b>Bronx: PM2.5 and Asthma ED Rates (2009-2023)</b>",
      font = list(size = 16)
    ),
    xaxis = list(title = "Year", tickfont = list(size = 12)),
    yaxis = list(
      title = "<b style='color:#31688E'>PM2.5 (μg/m³)</b>",
      titlefont = list(color = "#31688E", size = 14),
      tickfont = list(color = "#31688E", size = 12),
      side = "left"
    ),
    yaxis2 = list(
      title = "<b style='color:#CC4678'>ED Visit Rate (per 10,000)</b>",
      titlefont = list(color = "#CC4678", size = 14),
      tickfont = list(color = "#CC4678", size = 12),
      overlaying = "y",
      side = "right"
    ),
    legend = list(
      x = 0.02,
      y = 0.98,
      xanchor = "left",
      yanchor = "top",
      bgcolor = "rgba(255,255,255,0.8)",
      bordercolor = "rgba(0,0,0,0.3)",
      borderwidth = 1
    ),
    hovermode = "x unified",
    plot_bgcolor = 'rgba(250,250,250,0.9)',
    paper_bgcolor = 'white',
    margin = list(r = 100, t = 60)
  )
```

```{r dual-axis-brooklyn, fig.width=10, fig.height=5}
# Brooklyn dual-axis plot
brooklyn_data <- pm25_asthma_clean %>% filter(borough == "Brooklyn")

plot_ly(brooklyn_data) %>%
  add_trace(
    x = ~year, 
    y = ~pm25_annual,
    name = "PM2.5",
    type = "scatter",
    mode = "lines+markers",
    line = list(color = "#35B779", width = 3),
    marker = list(size = 8),
    yaxis = "y1",
    hovertemplate = paste(
      '<b>PM2.5</b><br>',
      'Year: %{x}<br>',
      'PM2.5: %{y:.2f} μg/m³<br>',
      '<extra></extra>'
    )
  ) %>%
  add_trace(
    x = ~year,
    y = ~asthma_rate,
    name = "Asthma ED Rate",
    type = "scatter",
    mode = "lines+markers",
    line = list(color = "#F98E09", width = 3, dash = "dash"),
    marker = list(size = 8, symbol = "square"),
    yaxis = "y2",
    hovertemplate = paste(
      '<b>Asthma ED Rate</b><br>',
      'Year: %{x}<br>',
      'Rate: %{y:.1f} per 10,000<br>',
      '<extra></extra>'
    )
  ) %>%
  layout(
    title = list(
      text = "<b>Brooklyn: PM2.5 and Asthma ED Rates (2009-2023)</b>",
      font = list(size = 16)
    ),
    xaxis = list(title = "Year", tickfont = list(size = 12)),
    yaxis = list(
      title = "<b style='color:#35B779'>PM2.5 (μg/m³)</b>",
      titlefont = list(color = "#35B779", size = 14),
      tickfont = list(color = "#35B779", size = 12),
      side = "left"
    ),
    yaxis2 = list(
      title = "<b style='color:#F98E09'>ED Visit Rate (per 10,000)</b>",
      titlefont = list(color = "#F98E09", size = 14),
      tickfont = list(color = "#F98E09", size = 12),
      overlaying = "y",
      side = "right"
    ),
    legend = list(
      x = 0.02,
      y = 0.98,
      xanchor = "left",
      yanchor = "top",
      bgcolor = "rgba(255,255,255,0.8)",
      bordercolor = "rgba(0,0,0,0.3)",
      borderwidth = 1
    ),
    hovermode = "x unified",
    plot_bgcolor = 'rgba(250,250,250,0.9)',
    paper_bgcolor = 'white',
    margin = list(r = 100, t = 60)
  )
```

```{r dual-axis-queens, fig.width=10, fig.height=5}
# Queens dual-axis plot
queens_data <- pm25_asthma_clean %>% filter(borough == "Queens")

plot_ly(queens_data) %>%
  add_trace(
    x = ~year, 
    y = ~pm25_annual,
    name = "PM2.5",
    type = "scatter",
    mode = "lines+markers",
    line = list(color = "#1F9E89", width = 3),
    marker = list(size = 8),
    yaxis = "y1",
    hovertemplate = paste(
      '<b>PM2.5</b><br>',
      'Year: %{x}<br>',
      'PM2.5: %{y:.2f} μg/m³<br>',
      '<extra></extra>'
    )
  ) %>%
  add_trace(
    x = ~year,
    y = ~asthma_rate,
    name = "Asthma ED Rate",
    type = "scatter",
    mode = "lines+markers",
    line = list(color = "#E16462", width = 3, dash = "dash"),
    marker = list(size = 8, symbol = "square"),
    yaxis = "y2",
    hovertemplate = paste(
      '<b>Asthma ED Rate</b><br>',
      'Year: %{x}<br>',
      'Rate: %{y:.1f} per 10,000<br>',
      '<extra></extra>'
    )
  ) %>%
  layout(
    title = list(
      text = "<b>Queens: PM2.5 and Asthma ED Rates (2009-2023)</b>",
      font = list(size = 16)
    ),
    xaxis = list(title = "Year", tickfont = list(size = 12)),
    yaxis = list(
      title = "<b style='color:#1F9E89'>PM2.5 (μg/m³)</b>",
      titlefont = list(color = "#1F9E89", size = 14),
      tickfont = list(color = "#1F9E89", size = 12),
      side = "left"
    ),
    yaxis2 = list(
      title = "<b style='color:#E16462'>ED Visit Rate (per 10,000)</b>",
      titlefont = list(color = "#E16462", size = 14),
      tickfont = list(color = "#E16462", size = 12),
      overlaying = "y",
      side = "right"
    ),
    legend = list(
      x = 0.02,
      y = 0.98,
      xanchor = "left",
      yanchor = "top",
      bgcolor = "rgba(255,255,255,0.8)",
      bordercolor = "rgba(0,0,0,0.3)",
      borderwidth = 1
    ),
    hovermode = "x unified",
    plot_bgcolor = 'rgba(250,250,250,0.9)',
    paper_bgcolor = 'white',
    margin = list(r = 100, t = 60)
  )
```

```{r dual-axis-staten-island, fig.width=10, fig.height=5}
# Staten Island dual-axis plot
staten_data <- pm25_asthma_clean %>% filter(borough == "Staten Island")

plot_ly(staten_data) %>%
  add_trace(
    x = ~year, 
    y = ~pm25_annual,
    name = "PM2.5",
    type = "scatter",
    mode = "lines+markers",
    line = list(color = "#B5DE2B", width = 3),
    marker = list(size = 8),
    yaxis = "y1",
    hovertemplate = paste(
      '<b>PM2.5</b><br>',
      'Year: %{x}<br>',
      'PM2.5: %{y:.2f} μg/m³<br>',
      '<extra></extra>'
    )
  ) %>%
  add_trace(
    x = ~year,
    y = ~asthma_rate,
    name = "Asthma ED Rate",
    type = "scatter",
    mode = "lines+markers",
    line = list(color = "#FCA50A", width = 3, dash = "dash"),
    marker = list(size = 8, symbol = "square"),
    yaxis = "y2",
    hovertemplate = paste(
      '<b>Asthma ED Rate</b><br>',
      'Year: %{x}<br>',
      'Rate: %{y:.1f} per 10,000<br>',
      '<extra></extra>'
    )
  ) %>%
  layout(
    title = list(
      text = "<b>Staten Island: PM2.5 and Asthma ED Rates (2009-2023)</b>",
      font = list(size = 16)
    ),
    xaxis = list(title = "Year", tickfont = list(size = 12)),
    yaxis = list(
      title = "<b style='color:#B5DE2B'>PM2.5 (μg/m³)</b>",
      titlefont = list(color = "#B5DE2B", size = 14),
      tickfont = list(color = "#B5DE2B", size = 12),
      side = "left"
    ),
    yaxis2 = list(
      title = "<b style='color:#FCA50A'>ED Visit Rate (per 10,000)</b>",
      titlefont = list(color = "#FCA50A", size = 14),
      tickfont = list(color = "#FCA50A", size = 12),
      overlaying = "y",
      side = "right"
    ),
    legend = list(
      x = 0.02,
      y = 0.98,
      xanchor = "left",
      yanchor = "top",
      bgcolor = "rgba(255,255,255,0.8)",
      bordercolor = "rgba(0,0,0,0.3)",
      borderwidth = 1
    ),
    hovermode = "x unified",
    plot_bgcolor = 'rgba(250,250,250,0.9)',
    paper_bgcolor = 'white',
    margin = list(r = 100, t = 60)
  )
```